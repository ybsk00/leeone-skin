# 마케팅툴 + 헬스케어(퍼널1) 최종 구현 작업지시서 (AntiGravity)
> 범위: **신규 마케팅 분석툴(어드민 메뉴)** + **퍼널1 헬스케어 전환/프롬프트/토픽 격리 개선**  
> 목적: **UTM/30일 추적 → 퍼널 KPI → 전환 여정(UTM→퍼널1→퍼널2→예약)** + **퍼널1→퍼널2 트리거 강화**  
> 주의: 퍼널1은 “병원 느낌” 최소화(정보/기록 도구 포지션), 의료행위(진단/치료/약/시술) 금지

---

## 0. 문제정의(현재 리스크)
1) 퍼널1(비회원) → 퍼널2(로그인) 전환 트리거가 약함  
2) 탭(소화/인지/수면·스트레스/혈관/여성) 전환 시 컨텍스트가 섞여 LLM이 **소화로 답변을 끌고 가는 현상** 발생 가능(단일 messages 공유/서버 필터 미흡)  
3) 질문 풀이 3개 수준이라 5턴 대화가 단조롭고 “와닿음”이 부족함(광고/블로그 유입 이탈)

---

## 1. 목표
### 1) 퍼널1 → 퍼널2 전환 트리거(강전환) 구현
퍼널1 종료(5턴) 시 **도구형 트리거 3종**으로 로그인 명분 강화(병원/진료 문구 배제):
- A. **저장(손실회피)**: 요약은 브라우저 종료 시 사라질 수 있음 → 저장/이어하기는 로그인 필요
- C. **자료 업로드 후 한 페이지 정리(참고용)**: 검사결과/복용목록/처방전/메모 업로드 → 요약/정리(로그인 후)
- D. **7일/30일 비교**: 동일 체크 재실행 시 변화 비교(리듬 점수/패턴 변화)(로그인 후)

### 2) 토픽 격리로 “소화만 답변” 문제 제거
- 프론트/서버/프롬프트 3중 방어로 topic 컨텍스트 혼합을 원천 차단

### 3) 퍼널1 “와닿음” 강화
- **entry_intent(광고 소재별 유입 맥락)** 도입
- 1턴부터 “요약 카드 1문장 + 작은 실천 1문장 + 질문 1개” 고정
- 토픽별 질문 풀 최소 10개 이상 확장 + entry_intent에 따른 우선순위 재정렬

---

## 2. 메뉴/페이지 범위
### 2.1 관리자 대시보드(마케팅툴)
- 메뉴명: `마케팅 분석` 또는 `퍼널 트래킹`
- 기능:
  1) UTM 생성기(meta/google/naver/blog/other1/other2)
  2) 30일 visitor_id 추적(쿠키)
  3) 퍼널 이벤트 수집 및 KPI(일간/전체)
  4) 전환 유저 여정 조회(UTM → 퍼널1 → 퍼널2 → 예약)

### 2.2 퍼널1(헬스케어)
- 토픽 탭별 컨텍스트 완전 분리
- entry_intent 반영
- 5턴 종료 시 “요약 카드 + 저장/업로드/비교 CTA” 컴포넌트 노출

---

## 3. 퍼널1 → 퍼널2 트리거(필수 UI)
### 3.1 5턴 종료 화면(필수 컴포넌트)
- 제목: `내 컨디션 리듬 요약(오늘)`
- 서브: `참고용 정리입니다. 진단/치료 목적이 아닙니다.`
- 본문: LLM 최종 요약(200~250자)

#### CTA 3종(로그인 유도, 병원/의료진 문구 금지)
1) 버튼 A: `저장하고 이어하기(로그인)`
   - 설명: `이 요약은 브라우저를 닫으면 사라질 수 있습니다. 저장하면 다음에 1분 만에 이어서 볼 수 있습니다.`
2) 버튼 C: `자료 업로드하고 한 페이지로 정리(로그인)`
   - 설명: `검사결과/복용목록/처방전/메모를 올리면 핵심만 정리해 드립니다(참고용).`
3) 버튼 D: `7일 뒤 변화 비교 설정(로그인)`
   - 설명: `같은 체크로 다시 입력하면 변화가 비교됩니다.`

---

## 4. “소화만 답변” 문제 해결: 토픽 격리 3중 방어(필수)
### 4.1 프론트 상태 분리(필수)
- 단일 `messages[]` 공유 금지
- **topic별 messages 상태를 별도로 관리**
  - `messagesByTopic: Record<Topic, Message[]>`
  - 탭 변경 시 해당 topic messages만 렌더/전송

### 4.2 서버 입력/DB 조회 필터(필수)
- Chat API 요청 payload 필수:
  - `visitor_id`, `topic`, `turnCount`, `entry_intent?(optional)`
- 메시지 로드/저장 시 DB 조건 필수:
  - `WHERE visitor_id = ? AND topic = ?`
- 캐시 키도 topic 포함:
  - `cache:${visitor_id}:${topic}`

### 4.3 프롬프트 토픽 가드(필수)
- 시스템 프롬프트에 고정 문구 3줄 추가:
  - `현재 토픽은 "${topic}"이며, 답변은 반드시 이 토픽 범위 내에서만 작성합니다.`
  - `이전 토픽 대화 내용은 참고하지 않습니다.`
  - `토픽 변경은 사용자의 요청이 아니라 UI 파라미터(topic) 변경으로만 수행합니다.`

---

## 5. entry_intent(광고 소재별) 적용(MVP 6개)
### 5.1 URL 규칙
- 예: `/healthcare/chat?topic=digestion&entry_intent=digestion-night&utm_source=...`
- entry_intent는 **1~2턴 훅(요약 문장/첫 질문 우선순위)**에만 사용  
  (하드코딩으로 주제 고정 금지, 이후는 topic 질문 풀 기반)

### 5.2 MVP entry_intent 6개
- 소화: `digestion-night`, `digestion-aftermeal`, `digestion-stress`
- 수면/스트레스: `sleep-onset`, `sleep-awake`, `stress-overload`

---

## 6. 마케팅툴: 데이터/이벤트 트래킹
### 6.1 visitor_id 쿠키 정책
- 기본 도메인: `www.widamcare.co.kr`
- 권장(서브도메인 공유 필요 시): `Domain=.widamcare.co.kr`
- 만료: 30일
- 값: UUID v4

### 6.2 퍼널 이벤트(필수 수집)
- `page_view` (path, referrer, utm_*)
- `module_select` (topic)
- `chat_start` (topic, entry_intent)
- `turn_complete` (topic, turn_index)
- `final_summary_view` (topic)
- `cta_save_click` / `cta_upload_click` / `cta_compare_click`
- `login_success` (visitor_id + user_id 매핑)
- `reservation_created` (user_id, reservation_id)

---

## 7. 관리자 대시보드 요구사항(마케팅툴)
### 7.1 UTM 생성기
- 입력:
  - 채널: meta/google/naver/blog/other1/other2
  - campaign/adset/ad/content/term(정의 후 필수/선택 지정)
  - other1, other2: **사용자 입력 key** + **시스템 자동 생성 value**(slug/shortid/uuid)
- 출력:
  - 최종 URL(query 포함)
  - 복사 버튼
  - 생성 기록 저장(옵션)

### 7.2 KPI 대시보드(전체/일간)
- Unique 방문자(visitor_id)
- 퍼널1 진입, 5턴 완료율
- 퍼널2(로그인) 전환율
- 예약 전환율
- 일간 상세: 전환 건별 유입 UTM, 최초 방문일, 최종 전환일, 경로 타임라인

### 7.3 전환 유저 여정 조회
- 필터: 기간/채널/캠페인/topic
- 결과: 유저 단위 타임라인(UTM → 퍼널1 topic → CTA → 로그인 → 예약)

---

## 8. QA 시나리오(필수)
1) 탭 전환
   - 소화에서 2턴 → 수면 탭 전환 → 수면 질문/요약만 나오는지(이전 문맥 불참조)
2) entry_intent
   - `digestion-night`로 진입 시 첫 요약 문장이 야식/시간대 훅을 반영하는지
3) 5턴 종료 트리거
   - 요약 카드 노출 + 저장/업로드/비교 CTA 클릭 시 로그인 흐름 정상
4) 30일 쿠키 유지
5) 이벤트 로깅 및 KPI 수치 일치

---

# 9. 헬스케어 프롬프트 “최종 수정본(통합)” (붙여넣기용)
> 목적: 기존 프롬프트(위담 건강가이드) 기반을 개선하되,
> - **토픽 격리 가드**
> - **1턴부터 와닿는 요약 카드**
> - **3턴부터 저장 CTA**
> - **질문풀 확장 + entry_intent 우선순위**
> 를 포함한 최종본

## 9.1 Type / 함수 시그니처(변경)
- 기존: `getHealthcareSystemPrompt(topic, turnCount)`
- 변경: `getHealthcareSystemPrompt(topic, turnCount, entryIntent?)`
- 최종 요약도 entryIntent 반영 가능:
  - `getHealthcareFinalAnalysisPrompt(topic, entryIntent?)`

---

```ts
// 헬스케어 AI 시스템 프롬프트 (비회원, 문진/진단 없음, 생활리듬 점검)
// =============================================

type EntryIntent =
  | "digestion-night"
  | "digestion-aftermeal"
  | "digestion-stress"
  | "sleep-onset"
  | "sleep-awake"
  | "stress-overload"
  | string;

export function getHealthcareSystemPrompt(
  topic: string,
  turnCount: number,
  entryIntent?: EntryIntent
): string {
  const isLastTurn = turnCount >= 4;
  const includeSaveCta = turnCount >= 2; // 3턴부터 저장 CTA 삽입
  const intentHook = getEntryIntentHook(topic, entryIntent);

  return `
[역할]
당신은 "컨디션 리듬 체크(참고용)" 안내자입니다.
의료인이 아니며, 의료적 판단(진단/치료/처방/약/시술/수술)을 하지 않습니다.

[목적]
생활 리듬(식사·수면·활동·스트레스)을 짧게 정리하고,
오늘부터 적용 가능한 "작은 실천 1가지"를 제안합니다.
대화의 목표는 "요약을 저장하고 이어서 보기(로그인)"로 자연스럽게 연결하는 것입니다.

[토픽 가드(필수)]
- 현재 토픽은 "${topic}"이며, 답변은 반드시 이 토픽 범위 내에서만 작성합니다.
- 이전 토픽 대화 내용은 참고하지 않습니다.
- 토픽 변경은 사용자의 요청이 아니라 UI 파라미터(topic) 변경으로만 수행합니다.

[출력 규칙]
- 150~200자 내외
- 이모지 금지, 과도한 친근 표현 금지("알겠어요/그럼요/맞아요" 금지)
- 한 번에 질문은 1개만
- 대화에 없는 내용을 지어내지 않음
- 사용자의 불편을 의학적으로 단정하지 않음
- "증상/원인" 단어는 사용자에게 직접 쓰지 않음(대신 '불편감/패턴/리듬/컨디션' 사용)

[절대 금지]
- 병명/질환명/약/시술/수술 언급 금지
- "진단/처방/치료" 표현 금지
- 확정/단정("~입니다", "~때문입니다") 금지
- 공포 조장 금지

[대화 구조(고정)]
아래 순서를 반드시 지킵니다.
1) (1턴부터) '요약 카드' 1문장: 사용자 답변 + 인텐트 훅을 반영해 패턴을 정리(단정 금지)
2) '작은 실천' 1문장: 오늘 바로 가능한 수준(하나만)
3) '질문' 1개: 질문 풀에서 선택(이미 답한 내용 재질문 금지)
${includeSaveCta ? `4) (3턴부터) 저장 문장 1문장: "이 정리는 저장해두면 다음에 비교/이어가기가 쉽습니다(로그인)." (병원/의료진 언급 금지)` : ``}
${isLastTurn ? `5) (5턴) 마지막에는 저장/이어하기 CTA를 더 명확히 포함` : ``}

[설명 요청 처리 - 중요]
사용자가 "왜 이럴까요/뭐가 문제죠/어떻게 하면 좋죠"처럼 설명을 요구하면:
→ 1문장으로 '생활 리듬 관점'에서만 정리한 뒤,
→ 바로 질문 1개로 마무리합니다(문진 확장 금지).

[전환 규칙(중요)]
사용자가 의학적 판단(진단/치료/검사/약)을 요구하거나 불안이 큰 경우:
→ "이 단계에서는 단정할 수 없어, 요약을 저장하고 이어서 확인하는 방식이 안전합니다(로그인)." 문장을 포함합니다.

[인텐트 훅(유입 문맥 반영)]
${intentHook}

[질문 선택 규칙]
아래 질문 풀에서 현재 토픽에 맞는 질문을 1개만 선택합니다.
이미 사용자가 답한 항목은 다시 묻지 않습니다.

[질문 풀]
${getHealthcareQuestionPool(topic, entryIntent)}

[현재 턴: ${turnCount + 1}/5]
`;
}

// entry_intent 훅: 1턴부터 "내 얘기 같다"를 만드는 시작 문장 가이드
function getEntryIntentHook(topic: string, entryIntent?: EntryIntent): string {
  const intent = entryIntent || "";

  const map: Record<string, string> = {
    "digestion-night":
      `- 유입 맥락: 늦은 식사/야식이 잦아 리듬이 흔들리는 케이스를 우선 고려해 요약하세요.`,
    "digestion-aftermeal":
      `- 유입 맥락: 식후 일정 시간대에 불편감이 올라오는 패턴을 우선 고려해 요약하세요.`,
    "digestion-stress":
      `- 유입 맥락: 스트레스 높은 날에 수면·식사 리듬이 함께 흔들리는 패턴을 우선 고려해 요약하세요.`,
    "sleep-onset":
      `- 유입 맥락: 잠들기까지 시간이 길어 취침 전 자극(화면/카페인)과 기상 리듬을 우선 고려해 요약하세요.`,
    "sleep-awake":
      `- 유입 맥락: 중간 각성/새벽에 자주 깨는 패턴을 우선 고려해 요약하세요.`,
    "stress-overload":
      `- 유입 맥락: 스트레스 과부하로 컨디션 변동이 커진 패턴(수면/카페인/활동 연결)을 우선 고려해 요약하세요.`,
  };

  const fallbackByTopic: Record<string, string> = {
    digestion: `- 유입 맥락: 식사 타이밍/속도/야식과 컨디션 리듬을 우선 고려해 요약하세요.`,
    cognitive: `- 유입 맥락: 집중 시간대/화면 사용/수면과 컨디션 리듬을 우선 고려해 요약하세요.`,
    "stress-sleep": `- 유입 맥락: 입면/각성/취침 전 루틴과 리듬을 우선 고려해 요약하세요.`,
    vascular: `- 유입 맥락: 좌식/활동량/식단/수분과 생활 리듬을 우선 고려해 요약하세요.`,
    women: `- 유입 맥락: 주기 변동과 수면/스트레스 연결을 우선 고려해 요약하세요.`,
  };

  return map[intent] || fallbackByTopic[topic] || `- 유입 맥락: 식사·수면·활동 중 흔들리는 축을 먼저 찾아 요약하세요.`;
}

// 질문 풀 확장 + entry_intent 우선순위 재정렬
function getHealthcareQuestionPool(topic: string, entryIntent?: EntryIntent): string {
  const intent = entryIntent || "";

  const pools: Record<string, string[]> = {
    digestion: [
      "야식은 일주일에 몇 번 정도인가요(0~2/3~4/5회 이상)?",
      "보통 마지막 식사와 취침 사이 간격은 어느 정도인가요(1시간 이내/1~2시간/2시간 이상)?",
      "식후 바로 눕거나 앉아 있는 시간이 긴가요(예/아니오)?",
      "식사 시간이 매일 비슷한 편이신가요(규칙적/들쑥날쑥)?",
      "식사 속도는 빠른 편인가요(빠름/보통/천천히)?",
      "한 번에 먹는 양이 들쑥날쑥한 편인가요(예/아니오)?",
      "카페인은 오후에도 드시나요(거의 안 함/가끔/자주)?",
      "외식/배달 비중이 높은 편인가요(낮음/보통/높음)?",
      "주말에 식사 시간이 크게 바뀌나요(거의 없음/2시간 이상 바뀜)?",
      "스트레스가 높은 날에 컨디션이 더 흔들리나요(예/아니오)?",
    ],
    cognitive: [
      "집중이 떨어지는 시간대가 있나요(오전/오후/밤/불규칙)?",
      "화면 사용 시간이 하루 6시간 이상인가요(예/아니오)?",
      "수면이 6시간 미만인 날이 자주 있나요(예/아니오)?",
      "낮에 졸림이 잦은 편인가요(예/아니오)?",
      "카페인은 오후에도 드시나요(거의 안 함/가끔/자주)?",
      "주말에 수면 시간이 크게 바뀌나요(예/아니오)?",
      "주 2~3회 가벼운 활동이 가능한가요(예/아니오)?",
      "스트레스가 높을 때 컨디션 변동이 커지나요(예/아니오)?",
      "기상 후 개운함은 어떤가요(좋음/보통/나쁨)?",
      "최근 2주간 리듬이 흔들린 사건(야근/여행 등)이 있었나요(예/아니오)?",
    ],
    "stress-sleep": [
      "잠드는 데 오래 걸리시나요, 중간에 깨시나요(입면/각성/둘 다)?",
      "취침 전 화면(폰/PC/TV) 시간이 긴 편인가요(예/아니오)?",
      "카페인은 오후에도 드시나요(거의 안 함/가끔/자주)?",
      "기상 시간이 평일/주말에 많이 다른가요(1시간 이내/2시간 이상)?",
      "낮에 30분 이상 낮잠을 자주 자나요(예/아니오)?",
      "취침 직전에 생각이 많아지는 편인가요(예/아니오)?",
      "저녁에 야식/음주가 있는 편인가요(거의 없음/가끔/자주)?",
      "기상 후 개운함은 어떤가요(좋음/보통/나쁨)?",
      "하루 중 가장 피곤한 시간대가 있나요(오전/오후/밤)?",
      "아침 햇빛을 보는 시간이 있나요(예/아니오)?",
    ],
    vascular: [
      "앉아 있는 시간이 하루 7시간 이상인가요(예/아니오)?",
      "짠 음식/가공식품을 자주 드시나요(드묾/보통/자주)?",
      "물을 하루 1L 이상 마시나요(예/아니오)?",
      "일주일에 3번 이상 20분 걷기가 가능하신가요(예/아니오)?",
      "주말에 활동량이 확 줄어드나요(예/아니오)?",
      "야식/음주가 주 2회 이상인가요(예/아니오)?",
      "수면이 6시간 미만인 날이 자주 있나요(예/아니오)?",
      "스트레스가 높을 때 컨디션 변동이 큰가요(예/아니오)?",
      "외식 비중이 높은 편인가요(낮음/보통/높음)?",
      "하루 중 가장 피곤한 시간대가 있나요(오전/오후/밤)?",
    ],
    women: [
      "컨디션이 떨어지는 시기가 매달 비슷하게 반복되나요(예/아니오)?",
      "수면/스트레스가 컨디션에 영향을 주는 편인가요(예/아니오)?",
      "통증/피로가 심해지는 시점이 주기와 연결되나요(예/아니오/모르겠음)?",
      "주기가 비교적 규칙적인가요(규칙/들쑥날쑥)?",
      "카페인/야식이 있는 주에 더 흔들리나요(예/아니오)?",
      "붓기/두통/기분 변동이 동반되나요(예/아니오)?",
      "수면이 6시간 미만인 날이 잦나요(예/아니오)?",
      "식사 시간이 불규칙한 편인가요(예/아니오)?",
      "주말에 수면/식사 시간이 크게 바뀌나요(예/아니오)?",
      "최근 3개월 내 리듬을 흔든 변화(야근/여행 등)가 있었나요(예/아니오)?",
    ],
    default: [
      "식사·수면·활동 중 가장 불규칙한 부분은 무엇인가요?",
      "최근 2주 동안 리듬이 흔들린 이유가 있었나요(예/아니오)?",
      "야식/카페인/화면 사용 중 가장 영향이 큰 건 무엇인가요?",
      "수면이 6시간 미만인 날이 자주 있나요(예/아니오)?",
      "주말에 생활 패턴이 크게 달라지나요(예/아니오)?",
      "주 2~3회 가벼운 활동이 가능한가요(예/아니오)?",
      "스트레스가 높은 날에 컨디션 변동이 커지나요(예/아니오)?",
      "식사 속도는 빠른 편인가요(빠름/보통/천천히)?",
      "하루 중 가장 컨디션이 떨어지는 시간대가 있나요(오전/오후/밤)?",
      "하루 물 섭취는 어느 정도인가요(1L 미만/1~1.5L/1.5L 이상)?",
    ],
  };

  const base = pools[topic] || pools.default;

  const prioritized = prioritizeByIntent([...base], intent);
  return prioritized.join(" / ");
}

function prioritizeByIntent(list: string[], intent: string): string[] {
  if (!intent) return list;

  if (intent === "digestion-night") return moveToFront(list, ["야식", "마지막 식사", "취침"]);
  if (intent === "digestion-aftermeal") return moveToFront(list, ["식후", "식사 속도", "식후 바로"]);
  if (intent === "digestion-stress") return moveToFront(list, ["스트레스", "수면", "카페인"]);
  if (intent === "sleep-onset") return moveToFront(list, ["잠드는", "화면", "카페인", "기상"]);
  if (intent === "sleep-awake") return moveToFront(list, ["중간에", "깨", "야식", "화면"]);
  if (intent === "stress-overload") return moveToFront(list, ["스트레스", "수면", "카페인", "활동"]);

  return list;
}

function moveToFront(list: string[], keywords: string[]): string[] {
  const scored = list.map((item) => {
    const score = keywords.reduce((acc, k) => (item.includes(k) ? acc + 1 : acc), 0);
    return { item, score };
  });
  scored.sort((a, b) => b.score - a.score);
  return scored.map((s) => s.item);
}

// 5턴 종료 최종 요약 프롬프트
export function getHealthcareFinalAnalysisPrompt(topic: string, entryIntent?: EntryIntent): string {
  const topicFocusMap: Record<string, string> = {
    digestion: "식사 타이밍/야식/식사 속도/식후 움직임/카페인",
    cognitive: "집중 시간대/화면 사용/수면/활동/스트레스",
    "stress-sleep": "입면/각성/취침 전 루틴/카페인/기상 리듬",
    vascular: "좌식/활동량/식단/수분/수면",
    women: "주기 변동/수면/스트레스/생활 패턴",
  };

  const focus = topicFocusMap[topic] ?? "식사/수면/활동/스트레스";
  const intentHint = getEntryIntentHook(topic, entryIntent);

  return `
[역할]
당신은 "컨디션 리듬 체크(참고용)" 안내자입니다.
5턴 대화를 바탕으로 사용자의 생활 리듬을 요약합니다(진단/치료 아님).

[토픽 가드]
- 현재 토픽은 "${topic}"이며 답변은 이 토픽 범위 내에서만 작성합니다.
- 이전 토픽 대화 내용은 참고하지 않습니다.

[분석 초점]
${focus}

[유입 맥락(참고)]
${intentHint}

[작성 규칙]
- 200~250자 내외
- 구성(고정):
  1) 리듬 요약 2문장(사용자 답변 근거, 단정 금지, '불편감/패턴/리듬' 사용)
  2) 오늘 가능한 실천 1가지(작게, 하나만)
  3) 다음 확인 질문 1개(선택형 1개)
  4) 저장/이어하기 CTA 1문장(로그인 명분: 기록 저장/비교/업로드)
- 절대 금지: 병명/질환명/약/시술/치료/검사 권유, 의료적 확정
`;
}
