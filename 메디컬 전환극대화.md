# [업데이트 작업지시] 퍼널2 “후기보기/위치보기” 기능 — 검색 API 기반 (AntiCravity)

## 0) 목적(왜 하는가)
- 퍼널2(로그인 후 메디컬)에서 사용자의 **병원 결정 과정**을 돕기 위해,
  - `후기 보기`(외부 공개 후기 링크 목록)
  - `위치 보기`(네이버지도/구글지도 링크)
  를 제공하여 **예약 전환율**을 높인다.
- 동시에 의료법/플랫폼/TOS 리스크를 줄이기 위해 **원문 복사·재게시 금지**, **링크 아웃 방식**으로 구현한다.

---

## 1) 핵심 원칙(리스크 최소화)
1. 후기 “원문”을 우리 서비스에 저장/렌더링하지 않는다.
   - 검색 API 결과의 **제목/작성일/출처/링크/스니펫(가능 시)** 정도만 표기
   - 클릭 시 외부 새 탭으로 이동(링크 아웃)
2. “좋은 후기만 선별” 같은 큐레이션 금지(중립 정렬)
   - 기본 정렬은 `최신순` 또는 `관련도순(API 기본)` 중 택1
3. 모달 상단 고지 문구 필수:
   - `외부 공개 검색 결과 링크를 제공합니다. 당사는 후기 내용을 작성/편집하지 않습니다.`
4. “체험단/협찬” 키워드가 포함될 수 있음을 고지(옵션 강화)

---

## 2) UI/UX 요구사항 (퍼널2 화면)
### 2.1 버튼 배치
- 퍼널2 메인 영역에 버튼 2개 추가:
  - `후기 보기`
  - `위치 보기`

### 2.2 후기 보기 모달(ReviewModal)
- 상단 고지(고정):
  - `외부 페이지로 이동합니다. 후기는 당사에서 작성/편집하지 않습니다.`
- 탭 구성(권장):
  1) 블로그
  2) 카페/커뮤니티
  3) 웹문서(기타)
- 카드 구성:
  - 제목(1줄), 출처, 날짜(가능 시)
  - 스니펫(1~2줄, API가 제공하면)
  - 버튼: `원문 보기`(새 탭)
- “더 보기” 페이징(10개 단위) 또는 무한 스크롤(간단 구현 우선)

### 2.3 위치 보기 모달(MapModal)
- 2개 버튼:
  - `네이버지도에서 보기`
  - `구글지도에서 보기`
- 모바일은 앱 설치 시 앱으로, 아니면 웹으로 이동

---

## 3) 데이터 소스: 검색 API 방식(권장)
### 3.1 네이버 검색 OpenAPI 사용(추천)
- 사용 엔드포인트(우선순위):
  - Blog: `blog`
  - Cafe: `cafearticle`
  - Web: `webkr`
- 검색 쿼리(기본):
  - `${HOSPITAL_NAME} 후기`
  - `${HOSPITAL_NAME} 방문 후기`
  - (옵션) `${HOSPITAL_NAME} 리뷰`  
- 제외 키워드(옵션):
  - `-광고 -협찬 -체험단 -원고료`
  - ※ 너무 강하게 제외하면 결과가 적어질 수 있으니 관리자 옵션으로 on/off

> 참고 URL(개발자 문서)
- 네이버 검색 OpenAPI: https://developers.naver.com/docs/serviceapi/search/

### 3.2 RSS는 보조(있으면만)
- RSS는 커버리지가 낮아서 MVP에서는 “검색 API”를 주 소스로 사용
- RSS 지원 채널이 확인되면 추후 `source=rss`로 확장 가능

---

## 4) 서버/API 설계 (Next.js Route Handler 기준)
### 4.1 새 API 라우트
- `GET /api/reviews/search`
  - Query:
    - `source` = `blog | cafe | web` (필수)
    - `q` = 검색어(옵션, 없으면 서버에서 병원명 기반 생성)
    - `start` = pagination start(옵션, 기본 1)
    - `display` = count(옵션, 기본 10)
  - Response(JSON):
    ```json
    {
      "source": "blog",
      "query": "위담한방병원 방문 후기",
      "items": [
        {
          "title": "...",
          "link": "...",
          "description": "...",
          "bloggername": "...",
          "postdate": "20251201",
          "origin": "naver"
        }
      ],
      "meta": { "total": 1234, "start": 1, "display": 10 },
      "cached": true
    }
    ```

### 4.2 환경변수(서버 전용)
- `NAVER_CLIENT_ID`
- `NAVER_CLIENT_SECRET`
- `HOSPITAL_REVIEW_QUERY_BASE` (예: `위담한방병원`)
- `HOSPITAL_MAP_QUERY` (예: `위담한방병원` 또는 주소)
- (옵션) `REVIEW_EXCLUDE_KEYWORDS` (기본 `광고,협찬,체험단,원고료`)

### 4.3 캐싱/레이트리밋(필수)
- 검색 API는 호출 비용/쿼터가 있으므로 캐싱을 권장
- 캐시 키:
  - `reviews:${source}:${query}:${start}:${display}`
- TTL:
  - 6~24시간(기본 12시간)
- 구현:
  - Supabase 테이블 캐시 또는 KV(가능한 방식 선택)
  - 최소 MVP: Supabase 테이블 캐시 추천

---

## 5) DB(신규) — 캐시 + 이벤트 로깅
### 5.1 검색 결과 캐시 테이블
- `review_search_cache`
  - `id` uuid pk
  - `cache_key` text unique
  - `source` text
  - `query` text
  - `payload` jsonb
  - `expires_at` timestamptz
  - `created_at` timestamptz default now()

### 5.2 이벤트 테이블(마케팅 KPI 연계)
- `marketing_events`
  - `id` uuid pk
  - `visitor_id` text
  - `user_id` uuid nullable
  - `event_name` text
  - `topic` text nullable
  - `entry_intent` text nullable
  - `utm_source` text nullable
  - `utm_medium` text nullable
  - `utm_campaign` text nullable
  - `utm_content` text nullable
  - `meta` jsonb (source, rank, link 등)
  - `created_at` timestamptz default now()

> 기존 이벤트 시스템이 있다면, 위 스키마는 “추가 필드”로 흡수/매핑

---

## 6) 트래킹 이벤트(필수)
후기/지도 기능의 “전환 기여”를 측정해야 하므로 아래 이벤트는 반드시 기록.

1) 후기 모달
- `review_modal_open`  
  - meta: `{ sourceTabsEnabled: true }`
- `review_source_tab_click`  
  - meta: `{ source: "blog" }`
- `review_click_out`  
  - meta: `{ source: "blog", rank: 1, link: "..." }`

2) 지도 모달
- `map_modal_open`
- `map_click`  
  - meta: `{ provider: "naver" | "google" }`

3) 예약 연결(기존 이벤트와 결합)
- `reservation_start`
- `reservation_complete`

---

## 7) 지도 링크 생성 규칙
### 7.1 네이버 지도
- 웹 링크(최소 MVP):
  - https://map.naver.com/v5/search/{QUERY}
- 앱 스킴(추후 고도화):
  - nmap://search?query={QUERY}&appname={APP_NAME}

### 7.2 구글 지도
- 웹 링크(최소 MVP):
  - https://www.google.com/maps/search/?api=1&query={QUERY}

> QUERY는 병원명 + 지역(가능하면) + 주소(가능하면) 조합으로 정밀도 향상

---

## 8) 보안/운영 주의사항
- API 키는 서버에서만 사용(클라이언트 노출 금지)
- 응답에 포함되는 링크는 XSS/인젝션 방지를 위해 URL 검증(스킴/도메인 체크)
- 모달 내 스니펫은 HTML 태그 제거/escape 처리
- “후기 원문 렌더링(iframe 포함)” 금지 — 반드시 링크 아웃

---

## 9) 개발 작업 순서(P0 → P1)
### P0 (MVP, 1차 배포 목표)
1. `/api/reviews/search` 구현(네이버 검색 API 호출 + 캐싱)
2. 퍼널2 UI에 버튼 추가(후기 보기/위치 보기)
3. 후기 모달 구현(탭 + 리스트 + 외부 링크)
4. 지도 모달 구현(네이버/구글 링크)
5. 이벤트 로깅(5~6개 필수 이벤트)

### P1 (전환 최적화)
1. 관리자에서 검색어 세팅(병원명/지점/주소) 편집 UI
2. 제외 키워드 on/off 토글(체험단/협찬 등)
3. 결과가 부족할 때 fallback query 자동 변경
   - 예: `방문 후기` → `후기` → `리뷰`
4. KPI 대시보드에서 “후기/지도 클릭 → 예약 전환” 퍼널 추가

---

## 10) QA 시나리오
1. 퍼널2에서 후기 모달 오픈 → 탭 전환 → 링크 클릭(새 탭) 정상
2. 캐시 적용 확인(동일 요청에서 API 호출 감소)
3. 지도 모달에서 네이버/구글 링크 정상 이동
4. 이벤트 로그가 visitor_id/utm/topic/entry_intent와 함께 저장되는지
5. “원문 복사/렌더링”이 없는지(링크 아웃만)

---

## 11) 완료 기준(Definition of Done)
- 퍼널2에서 “후기 보기/위치 보기”가 실제 동작
- 검색 API 기반 후기 링크 리스트가 모달에 표시되고 외부로 정상 이동
- 지도 링크가 네이버/구글로 정상 이동
- 이벤트가 저장되어 관리자 KPI에 활용 가능
- 원문 재게시/편집 없이 링크 기반으로만 제공(리스크 가드 준수)

